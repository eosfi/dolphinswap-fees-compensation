

目录：

- dolphin-pool-snapshot。修复手续费合约升级（2020-11-15 16:00:00）时的快照数据
- code。计算手续费分配的代码
- output。计算输出的结果表格
- img。辅助目录

### 1. 未分配手续费统计

截止2020-11-15 16:00:00的未分配手续费初步统计，依据2020-11-15 16:00:00合约升级时的数据表snapshot，统计表见文件：

dolphin-pool-snapshot/手续费差额汇总（依据snapshot).xlsx

注意本表为初步统计结果，详细结果见后续表格。

### 2. 分配方法

#### 2.1 手续费分为三个阶段

- 阶段1：起始时间2020-10-18 19:00:00，结束时间2020-11-13 16:00:00。为dolphinswap上线，至CASH交易挖矿上线期间。
- 阶段2：起始时间2020-11-13 16:00:00，结束时间2020-11-15 10:00:00。为CASH交易挖矿期间。
- 阶段3：起始时间2020-11-15 10:00:00，结束时间2020-11-15 16:00:00。为CASH交易挖矿结束，至手续费问题修复的时间段。

#### 2.2 各资金池手续费计算

根据每个阶段起始时刻和结束时刻的累计交易额数据(dolphinsswap的swapstats表，实时记录了各个资金池累计交易额)，计算该阶段应产生的手续费。手续费进入资金池的比例在2020-10-28 20:00:00做过调整，由原来的80%手续费金额进入资金池，修改为70%进入资金池。三个阶段，每个资金池的未分配手续费金额，计算如下：

1. 计算阶段1结束时刻和起始时刻，各资金池累计交易额差额，计算应产生的手续费，计算公式：
阶段1某资金池产生手续费 = 资金池累计交易额差额 * 70%（80%）

1. 计算阶段2的累计交易额差额，计算应产生的手续费，计算公式：
    阶段2某资金池产生手续费 = 资金池累计交易额差额 * 70%
2. 计算阶段3的累计交易额差额，计算应产生的手续费，计算公式：
    阶段3某资金池产生手续费 = 资金池累计交易额差额 * 70%

注意：实际计算时阶段1做了特殊处理，在区块149480609之前进入资金池的手续费为80%，之后是70%。

#### 2.3 手续费分配

在三个阶段内，将分别统计每个用户的做市量，做市时间，总做市量等数据，作为分配计算的依据。以阶段1为例，选择一个特定资金池，具体的计算模型如下：

假设阶段1起始时刻的EOS区块号为Ns，阶段1结束时刻的EOS区块号为Ne，由dfuse API获取块号Ns某资金池lptokens表，表中记录了每个用户的LP Token数量值Tu,n，该值表示此时某用户的做市份额；并累加计算得出总LP Token数量值Tn，该值表示此时资金池总金额对应的总LP Token数量。计算Ns区块到Ne区块的总LP Token累计值

![](https://github.com/eosfi/dolphinswap-fees-compensation/blob/main/img/f1.png)

计算某用户u在某资金池从Ns区块Ne区块的LP Token累积值，若某区块用户u没有做市，那么Tu,n为0，

![](https://github.com/eosfi/dolphinswap-fees-compensation/blob/main/img/f2.png)

该阶段，用户u的做市份额为Tu/Ttotal，据此计算出用户应分配的手续费。

#### 2.4 计算精确性和计算效率问题

1. 每个阶段内，再进一步分配子阶段，以天为单位（具体到起始和结束块号时，不一定是精确的一天），在这一天内按照做市份额比例分配手续费。这样做到了更精确，因为每天的交易额是不同的。
2. 在一个子阶段（天）内，程序未逐块计算，而是每两分钟采样一次，即每次跳过240个块。这样总计算时间由几十天降低到十几个小时。
3. 计算了以下资金池：1-7,28,48,62,66,102。其余资金池手续费金额极小，暂忽略。

#### 3. 运行结果

计算得出的总手续费统计见表：output/total_fees.csv

分配到各资金池的手续费见表：output/pool_fees.csv

最终补偿表（由各资金池计算得出的补偿表汇总而来）：

- output/user_CASH_fees.csv
- output/user_EOS_fees.csv
- ...



另外，输出数据中有更详细的表格，以资金池1为例：

- 资金池1（DOP/EOS）每个子阶段的手续费结果见表：pool1_dayfees.csv
- 每个子阶段（天）的详细补偿数据见表：pool1_day[1-30]_userfees.csv
